import React, { useState, useEffect, useRef } from 'react';

// --- LaTeX Helper Component ---
const KatexFormula = ({ formula, displayMode = false }) => {
  const [isLoaded, setIsLoaded] = useState(false);
  const containerRef = useRef(null);

  useEffect(() => {
    // 1. Load CSS
    if (!document.getElementById('katex-css')) {
      const link = document.createElement('link');
      link.id = 'katex-css';
      link.href = "https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css";
      link.rel = "stylesheet";
      document.head.appendChild(link);
    }

    // 2. Load JS
    if (!document.getElementById('katex-js')) {
      const script = document.createElement('script');
      script.id = 'katex-js';
      script.src = "https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js";
      script.onload = () => setIsLoaded(true);
      document.head.appendChild(script);
    } else if (window.katex) {
      setIsLoaded(true);
    } else {
      const checkInterval = setInterval(() => {
        if (window.katex) {
          setIsLoaded(true);
          clearInterval(checkInterval);
        }
      }, 100);
      return () => clearInterval(checkInterval);
    }
  }, []);

  useEffect(() => {
    if (isLoaded && window.katex && containerRef.current) {
      window.katex.render(formula, containerRef.current, {
        throwOnError: false,
        displayMode: displayMode
      });
    }
  }, [isLoaded, formula, displayMode]);

  return <span ref={containerRef} className={`${displayMode ? 'block my-4 text-center' : 'inline-block'}`}>{!isLoaded ? formula : ''}</span>;
};

// --- Main Component ---

export default function BayesianReport() {
  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 p-4 md:p-8">
      <div className="max-w-4xl mx-auto space-y-8">
        
        {/* Header */}
        <header className="text-center space-y-4 py-8 border-b border-slate-200">
          <div className="inline-flex items-center space-x-2 text-indigo-600 font-bold uppercase tracking-wider text-xs bg-indigo-50 px-3 py-1 rounded-full">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M22 10v6M2 10l10-5 10 5-10 5z"/>
              <path d="M6 12v5c3 3 9 3 12 0v-5"/>
            </svg>
            <span>Problem 8 Analysis</span>
          </div>
          <h1 className="text-4xl font-extrabold text-slate-900">Bayesian Normal-Normal Model</h1>
          <p className="text-lg text-slate-600 max-w-2xl mx-auto">
            A comprehensive solution derived from first principles.
          </p>
        </header>

        {/* 1. Original Question */}
        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden p-8 border-l-4 border-l-indigo-600">
          <h2 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">Original Question</h2>
          <div className="prose prose-slate max-w-none">
            <p className="text-lg font-serif italic text-slate-800 leading-relaxed">
              "Normal distribution with unknown mean: a random sample of <KatexFormula formula="n" /> students is drawn from a large population, and their weights are measured. The average weight of the <KatexFormula formula="n" /> sampled students is <KatexFormula formula="\bar{y} = 150" /> pounds. Assume the weights in the population are normally distributed with unknown mean <KatexFormula formula="\theta" /> and known standard deviation <KatexFormula formula="20" /> pounds. Suppose your prior distribution for <KatexFormula formula="\theta" /> is normal with mean <KatexFormula formula="180" /> and standard deviation <KatexFormula formula="40" />."
            </p>
          </div>
        </div>

        {/* 2. Detailed Solution */}
        <div className="space-y-6">
          <div className="flex items-center justify-between border-b border-slate-200 pb-2">
            <h2 className="text-2xl font-bold text-slate-900">Detailed Solution</h2>
            <span className="text-sm text-slate-500">Step-by-step Walkthrough</span>
          </div>

          <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden p-8">
            
            {/* Section A */}
            <div className="flex items-center space-x-3 mb-4 mt-8">
                <div className="flex-shrink-0 w-8 h-8 flex items-center justify-center bg-indigo-600 text-white font-bold rounded-full text-sm">A</div>
                <h3 className="text-xl font-bold text-slate-900">Posterior Distribution for <KatexFormula formula="\theta" /></h3>
            </div>
            
            <div className="space-y-4 text-slate-600 leading-relaxed">
              <p>
                To find the posterior, we use Bayes' Theorem:
                <KatexFormula formula="P(\theta|y) \propto P(y|\theta) P(\theta)" displayMode={true} />
              </p>
              
              <h4 className="font-bold text-slate-800 mt-4">1. Identify the Components</h4>
              <ul className="list-disc list-inside ml-4 space-y-1">
                <li><strong>Prior:</strong> Our belief about <KatexFormula formula="\theta" /> is <KatexFormula formula="\theta \sim N(180, 40^2)" />.</li>
                <li><strong>Likelihood:</strong> The sample mean <KatexFormula formula="\bar{y}" /> follows <KatexFormula formula="N(\theta, \sigma^2/n)" />. With <KatexFormula formula="\sigma=20" />, the variance is <KatexFormula formula="400/n" />.</li>
              </ul>

              <h4 className="font-bold text-slate-800 mt-4">2. Kernel Method</h4>
              <p>We write down the exponential parts (kernels) of the distributions, ignoring constants:</p>
              <div className="bg-slate-50 p-4 rounded-lg border border-slate-100 shadow-inner">
                <div className="mb-2"><strong>Prior Kernel:</strong></div>
                <KatexFormula formula="\exp\left[ -\frac{1}{2} \left(\frac{\theta - 180}{40}\right)^2 \right]" displayMode={true} />
                <div className="mb-2 mt-4"><strong>Likelihood Kernel:</strong></div>
                <KatexFormula formula="\exp\left[ -\frac{1}{2} \frac{(\bar{y} - \theta)^2}{20^2/n} \right] = \exp\left[ -\frac{n}{2} \left(\frac{150 - \theta}{20}\right)^2 \right]" displayMode={true} />
              </div>
              
              <h4 className="font-bold text-slate-800 mt-4">3. Completing the Square</h4>
              <p>Combining the exponents, we identify the coefficient of <KatexFormula formula="\theta^2" /> (which gives us the precision) and the linear coefficient of <KatexFormula formula="\theta" /> (which helps us find the mean).</p>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-4">
                <div className="bg-indigo-50 p-4 rounded-lg">
                  <span className="text-xs font-bold text-indigo-600 uppercase">New Precision (1/Variance)</span>
                  <div className="bg-white bg-opacity-60 p-2 rounded mt-2 text-sm text-center">
                    <KatexFormula formula="\frac{1}{\sigma_{post}^2} = \frac{1}{40^2} + \frac{n}{20^2}" displayMode={true} />
                    <KatexFormula formula="\sigma_{post}^2 = \frac{1600}{1 + 4n}" displayMode={true} />
                  </div>
                </div>
                <div className="bg-green-50 p-4 rounded-lg">
                   <span className="text-xs font-bold text-green-600 uppercase">New Mean (Weighted Average)</span>
                   <div className="bg-white bg-opacity-60 p-2 rounded mt-2 text-sm text-center">
                     <KatexFormula formula="\mu_{post} = \sigma_{post}^2 \left[ \frac{180}{40^2} + \frac{150 \cdot n}{20^2} \right]" displayMode={true} />
                     <KatexFormula formula="\mu_{post} = \frac{180 + 600n}{1 + 4n}" displayMode={true} />
                   </div>
                </div>
              </div>
              
              <p className="font-semibold text-slate-800 border-t border-slate-100 pt-4">Final Answer for (a):</p>
              <p>
                The posterior distribution is Normal with mean <KatexFormula formula="\frac{180 + 600n}{1 + 4n}" /> and variance <KatexFormula formula="\frac{1600}{1 + 4n}" />.
              </p>
            </div>

            {/* Section B */}
            <div className="flex items-center space-x-3 mb-4 mt-8">
                <div className="flex-shrink-0 w-8 h-8 flex items-center justify-center bg-indigo-600 text-white font-bold rounded-full text-sm">B</div>
                <h3 className="text-xl font-bold text-slate-900">Posterior Predictive Distribution for <KatexFormula formula="\tilde{y}" /></h3>
            </div>

            <div className="space-y-4 text-slate-600 leading-relaxed">
              <p>
                We want to predict the weight of a <em>new</em> student, <KatexFormula formula="\tilde{y}" />. This student comes from the population <KatexFormula formula="N(\theta, 20^2)" />.
              </p>
              <div>
                There are two independent sources of uncertainty:
                <ol className="list-decimal list-inside ml-4 mt-2 space-y-1">
                  <li>We don't know the true mean <KatexFormula formula="\theta" /> (Posterior Variance).</li>
                  <li>Students vary naturally around the mean (Population Variance <KatexFormula formula="20^2" />).</li>
                </ol>
              </div>
              <p>We add the variances:</p>
              <div className="bg-slate-50 p-4 rounded-lg border border-slate-100 shadow-inner text-center">
                <KatexFormula formula="\text{Var}(\tilde{y}) = \text{Var}(\theta|y) + \text{Var}(\text{student})" displayMode={true} />
                <KatexFormula formula="\text{Var}(\tilde{y}) = \frac{1600}{1 + 4n} + 400" displayMode={true} />
              </div>
              <p className="font-semibold text-slate-800 border-t border-slate-100 pt-4">Final Answer for (b):</p>
              <p>
                The predictive distribution is Normal with mean equal to the posterior mean, and variance <KatexFormula formula="\frac{1600}{1+4n} + 400" />.
              </p>
            </div>

            {/* Section C */}
            <div className="flex items-center space-x-3 mb-4 mt-8">
                <div className="flex-shrink-0 w-8 h-8 flex items-center justify-center bg-indigo-600 text-white font-bold rounded-full text-sm">C</div>
                <h3 className="text-xl font-bold text-slate-900">95% Intervals (n = 10)</h3>
            </div>

            <div className="space-y-4 text-slate-600 leading-relaxed">
              <p>Plugging <KatexFormula formula="n=10" /> into our derived formulas:</p>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="border border-slate-200 rounded-lg p-4">
                  <h5 className="font-bold text-slate-800 mb-2">Posterior Interval for <KatexFormula formula="\theta" /></h5>
                  <ul className="text-sm space-y-1 mb-2">
                    <li>Mean: <KatexFormula formula="(180 + 6000)/41 \approx 150.73" /></li>
                    <li>Variance: <KatexFormula formula="1600/41 \approx 39.02" /></li>
                    <li>SD: <KatexFormula formula="\sqrt{39.02} \approx 6.25" /></li>
                  </ul>
                  <div className="bg-slate-100 p-2 rounded text-center text-slate-800">
                    <KatexFormula formula="150.73 \pm (1.96 \times 6.25)" />
                    <div className="font-bold mt-1">[138.48, 162.98]</div>
                  </div>
                </div>

                <div className="border border-slate-200 rounded-lg p-4">
                  <h5 className="font-bold text-slate-800 mb-2">Predictive Interval for <KatexFormula formula="\tilde{y}" /></h5>
                  <ul className="text-sm space-y-1 mb-2">
                    <li>Mean: <KatexFormula formula="150.73" /></li>
                    <li>Variance: <KatexFormula formula="39.02 + 400 = 439.02" /></li>
                    <li>SD: <KatexFormula formula="\sqrt{439.02} \approx 20.95" /></li>
                  </ul>
                  <div className="bg-slate-100 p-2 rounded text-center text-slate-800">
                    <KatexFormula formula="150.73 \pm (1.96 \times 20.95)" />
                    <div className="font-bold mt-1">[109.67, 191.79]</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  );
}