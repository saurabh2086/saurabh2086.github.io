<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bayesian Beta-Blocker Analysis</title>
    <!-- 1. Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Load D3.js (for statistics) and D3-Random (for beta distribution) -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/d3-random.v3.min.js"></script>
    
    <!-- 3. Load KaTeX for LaTeX rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8dM9QStMqPvNBfIRzIZmISwNIcmncfl0R4ANaoGZEXHnRCvQR+Wglkvlo1Tj+vY" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlGwcjNPTcPGMmqAVaKexLzxHteItfq+A8/L+ZdcCPs+AChLKY/ZjwGMBE2" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" xintegrity="sha384-+VBxd3rBCQcRmWGfDVBQG+UQgMhKAUH8aZkSYWbY/wYiwKkCjxsBoMgiO8VGiiYg" crossorigin="anonymous"></script>
    
    <style>
        /* A simple style for the D3 plot axes */
        .domain, .tick line {
            stroke: #d1d5db; /* gray-300 */
        }
        .tick text {
            fill: #374151; /* gray-700 */
            font-family: sans-serif;
            font-size: 12px;
        }
        .plot-label {
            font-family: sans-serif;
            font-size: 14px;
            font-weight: 600;
            fill: #1f2937; /* gray-800 */
        }
        .home-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #2c3e50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        .home-button:hover {
            background: #34495e;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
    <a href="../../index.html" class="home-button">
        ‚Üê Home
    </a>

    <div class="max-w-5xl mx-auto p-6 md:p-10 bg-white shadow-lg rounded-lg my-10 space-y-10">

        <h1 class="text-3xl font-bold text-blue-800 mb-0 border-b pb-4">
            Bayesian Inference for Beta-Blocker Mortality
        </h1>

        <!-- Full Problem Text -->
        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
            <h2 class="text-xl font-semibold text-gray-700 mb-2">Problem Statement</h2>
            <p class="text-gray-700 leading-relaxed">
                "4. Inference for a 2 &times; 2 table: an experiment was performed to estimate the effect of beta-blockers on mortality of cardiac patients. A group of patients were randomly assigned to treatment and control groups: out of 674 patients receiving the control, 39 died, and out of 680 receiving the treatment, 22 died. Assume that the outcomes are independent and binomially distributed, with probabilities of death of $p_0$ and $p_1$ under the control and treatment, respectively. We return to this example in Section 5.6."
            </p>
            <ul class="list-disc list-inside mt-4 pl-2 space-y-1">
                <li>(a) Set up a noninformative prior distribution on $(p_0, p_1)$ and obtain posterior simulations.</li>
                <li>(b) Summarize the posterior distribution for the <i>odds ratio</i>, $\frac{p_1 / (1 - p_1)}{p_0 / (1 - p_0)}$.</li>
                <li>(c) Discuss the sensitivity of your inference to your choice of noninformative prior density.</li>
            </ul>
        </div>
        
        <!-- Data Summary -->
        <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
            <h2 class="text-xl font-semibold text-gray-700 mb-2">üìã Data Summary</h2>
            <p>We extract the key numbers from the problem statement:</p>
            <ul class="list-disc list-inside mt-3 space-y-1">
                <li><strong>Control Group:</strong> $y_0 = 39$ deaths out of $n_0 = 674$ patients.</li>
                <li><strong>Treatment Group:</strong> $y_1 = 22$ deaths out of $n_1 = 680$ patients.</li>
            </ul>
        </div>

        <!-- Part (a) - Now visible by default -->
        <section>
            <h2 class="text-2xl font-semibold text-blue-700 mb-3">
                (a) Noninformative Priors & Posterior Derivation
            </h2>
            <p class="mb-4">The first step is to define our Bayesian model. We are told the data is binomially distributed, so our <strong>likelihood</strong> is:</p>
            <ul class="list-disc list-inside pl-4 mb-4 space-y-1">
                 <li>$y_0 | p_0 \sim \text{Binomial}(n_0, p_0)$</li>
                 <li>$y_1 | p_1 \sim \text{Binomial}(n_1, p_1)$</li>
            </ul>
            <p class="mb-4">For the <strong>noninformative prior</strong>, we choose the conjugate prior for the Binomial likelihood, which is the Beta distribution. A common "noninformative" choice is $\text{Beta}(1, 1)$, which is equivalent to a Uniform(0, 1) distribution.</p>
            <p class="mb-4">
            Given the conjugacy rule (Prior: $\text{Beta}(\alpha, \beta)$ $\rightarrow$ Posterior: $\text{Beta}(\alpha + y, \beta + n - y)$), we can derive our two posterior distributions.
            </p>
            
            <div class="grid md:grid-cols-2 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <h3 class="font-bold text-blue-800">Control Group ($p_0$)</h3>
                    <p>Posterior: $\text{Beta}(\alpha_0 + y_0, \beta_0 + n_0 - y_0)$</p>
                    <p>Posterior: $\text{Beta}(1 + 39, 1 + 674 - 39)$</p>
                    <p class="font-bold text-lg mt-2">= $\text{Beta}(40, 636)$</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                    <h3 class="font-bold text-green-800">Treatment Group ($p_1$)</h3>
                    <p>Posterior: $\text{Beta}(\alpha_1 + y_1, \beta_1 + n_1 - y_1)$</p>
                    <p>Posterior: $\text{Beta}(1 + 22, 1 + 680 - 22)$</p>
                    <p class="font-bold text-lg mt-2">= $\text{Beta}(23, 659)$</p>
                </div>
            </div>
            <p class="mt-4 text-gray-700">We use these posterior distributions to generate simulations for parts (b) and (c).</p>
        </section>

        <!-- Results Wrapper - Now visible by default -->
        <div id="results-container" class="space-y-10">

            <!-- Part (b) -->
            <section>
                <h2 class="text-2xl font-semibold text-blue-700 mb-3">
                    (b) Posterior Distribution for the Odds Ratio
                </h2>
                <p class="mb-4">We draw 100,000 samples from each posterior and calculate the odds ratio (OR) for each sample: $OR = \frac{p_1 / (1 - p_1)}{p_0 / (1 - p_0)}$.</p>
                
                <!-- Plot Container -->
                <div id="plot-container" class="w-full bg-white border border-gray-200 rounded-lg p-4 mb-6">
                    <svg id="histogram-plot"></svg>
                </div>
                
                <!-- Summary Stats -->
                <div class="bg-gray-100 p-4 rounded-lg">
                    <h3 class="font-bold text-lg mb-2">Summary Statistics (from $\text{Beta}(1,1)$ prior)</h3>
                    <div id="summary-stats-1" class="text-base">
                        <!-- JS will inject stats here -->
                    </div>
                </div>
                
                <div id="interpretation-1" class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <!-- JS will inject interpretation here -->
                </div>
            </section>

            <!-- Part (c) -->
            <section>
                <h2 class="text-2xl font-semibold text-blue-700 mb-3">
                    (c) Sensitivity to Prior Choice
                </h2>
                <p class="mb-4">To check if our conclusion is robust, we re-run the analysis using a different noninformative prior: the <strong>Jeffreys Prior</strong>, $\text{Beta}(0.5, 0.5)$.</p>
                
                <!-- Updated explanation section for Jeffreys Prior -->
                <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <h4 class="font-semibold text-lg text-gray-800 mb-2">A Note on Priors: Why $\text{Beta}(0.5, 0.5)$?</h4>
                    <div class="space-y-3 text-gray-700">
                        <p>Our first choice, $\text{Beta}(1, 1)$, is the <strong>Uniform distribution</strong>. This <i>feels</i> noninformative because it assigns equal probability to every possible value of $p$ from 0 to 1.</p>
                        <p>However, this leads to a subtle problem. What if we were interested in the <strong>odds</strong> $o = \frac{p}{1-p}$? If you take our "flat" prior on $p$ and transform it to see what prior it implies for the odds $o$, that new prior is <i>not</i> flat. Our "unbiased" prior for $p$ is actually a <i>biased</i> prior for $o$.</p>
                        
                        <h5 class="font-semibold text-md text-gray-800 pt-2">The Concept of Fisher Information</h5>
                        <p>At its heart, <strong>Fisher Information</strong> is a way to measure how much "information" our data gives us about an unknown parameter. We can visualize this information by plotting the <strong>likelihood function</strong>. This graph has a peak at the most likely parameter value (e.g., $p_0 \approx 0.058$).</p>
                        
                        <ul class="list-disc list-inside pl-4">
                            <li><strong>A "Flat" Peak (Low Information):</strong> If we had little data (e.g., 2 patients), the peak would be very broad. This is <strong>low information</strong>.</li>
                            <li><strong>A "Sharp" Peak (High Information):</strong> With 674 patients, our peak is incredibly sharp and "pointy." This is <strong>high information</strong>.</li>
                        </ul>
                        
                        <p><strong>Fisher Information is the mathematical way to measure the "pointiness" (or "curvature") of this peak.</strong></p>
                        <div class="text-center italic text-sm text-gray-600 py-2">
                            
                            <p>A sharp peak (high information) vs. a flat peak (low information).</p>
                        </div>

                        <h5 class="font-semibold text-md text-gray-800 pt-2">Jeffreys' Solution: Invariance</h5>
                        <p>The <strong>Jeffreys Prior</strong> uses this concept to create a truly noninformative prior. His core idea was that a prior should be <strong>reparameterization invariant</strong>: the conclusion should be the same whether you are using the probability $p$ or the odds $o$.</p>
                        <p>The Fisher Information is the <i>one</i> tool that measures this "pointiness" in a way that accounts for the "stretching" of the x-axis when you change parameters. The Jeffreys prior is defined by the rule $p(\theta) \propto \sqrt{I(\theta)}$, where $I(\theta)$ is the Fisher Information.</p>
                        <p>For a Binomial likelihood, this rule results in:</p>
                        <p class="text-center font-medium text-lg my-2">$$ p(p) \propto p^{-0.5} (1-p)^{-0.5} $$</p>
                        <p>This formula corresponds to a <strong>$\text{Beta}(0.5, 0.5)$</strong> distribution. While it's "U-shaped" (placing more weight near 0 and 1), it is the most principled choice for a noninformative prior in this case, as it is mathematically invariant.</p>
                        <div class="text-center italic text-sm text-gray-600 py-2">
                            [Image of Beta(0.5, 0.5) distribution plot]
                            <p>The U-shaped Jeffreys prior, $\text{Beta}(0.5, 0.5)$</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-100 p-4 rounded-lg">
                    <h3 class="font-bold text-lg mb-2">Result Comparison</h3>
                    <div id="summary-stats-2" class="text-base">
                        <!-- JS will inject comparison stats here -->
                    </div>
                </div>
                
                <div id="interpretation-2" class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                    <!-- JS will inject sensitivity conclusion here -->
                </div>
            </section>
        </div>
        
    </div>

    <!-- 3. The JavaScript for Simulation and Plotting -->
    <script>
        // --- DOM Elements ---
        const plotContainer = document.getElementById('plot-container');
        const stats1El = document.getElementById('summary-stats-1');
        const interp1El = document.getElementById('interpretation-1');
        const stats2El = document.getElementById('summary-stats-2');
        const interp2El = document.getElementById('interpretation-2');
        
        /**
         * Runs N_samples of the OR simulation given posterior parameters
         */
        function runSimulation(N_samples, params) {
            const or_samples = new Array(N_samples);
            
            // Create reusable random number generators
            const betaSampler_p0 = d3.randomBeta(params.p0_alpha, params.p0_beta);
            const betaSampler_p1 = d3.randomBeta(params.p1_alpha, params.p1_beta);

            for (let i = 0; i < N_samples; i++) {
                const p0 = betaSampler_p0();
                const p1 = betaSampler_p1();
                
                const odds_0 = p0 / (1 - p0);
                const odds_1 = p1 / (1 - p1);
                
                or_samples[i] = odds_1 / odds_0;
            }
            return or_samples;
        }

        /**
         * Injects all results into the HTML
         */
        function displayResults(stats1, stats2) {
            // --- Part (b) Results ---
            stats1El.innerHTML = `
                <p><strong>Posterior Mean:</strong> ${stats1.mean.toFixed(4)}</p>
                <p><strong>Posterior Median:</strong> ${stats1.median.toFixed(4)}</p>
                <p><strong>95% Credible Interval:</strong> [${stats1.ci[0].toFixed(4)}, ${stats1.ci[1].toFixed(4)}]</p>
            `;
            
            const ci_is_below_one = stats1.ci[1] < 1.0;
            interp1El.innerHTML = `
                <h4 class="font-bold mb-1">Interpretation (Part b)</h4>
                ${ci_is_below_one
                    ? `<p>The 95% Credible Interval <strong>[${stats1.ci[0].toFixed(4)}, ${stats1.ci[1].toFixed(4)}]</strong> is entirely below 1.0. This provides strong evidence that the beta-blocker treatment is effective at reducing the odds of mortality.</p>`
                    : `<p>The 95% Credible Interval <strong>[${stats1.ci[0].toFixed(4)}, ${stats1.ci[1].toFixed(4)}]</strong> contains 1.0. We cannot conclude there is a statistically significant effect.</p>`
                }
            `;

            // --- Part (c) Results ---
            stats2El.innerHTML = `
                <p class="mb-2"><strong>$\text{Beta}(1, 1)$ Prior 95% CI:</strong> &nbsp;&nbsp; [${stats1.ci[0].toFixed(4)}, ${stats1.ci[1].toFixed(4)}]</p>
                <p><strong>$\text{Beta}(0.5, 0.5)$ Prior 95% CI:</strong> [${stats2.ci[0].toFixed(4)}, ${stats2.ci[1].toFixed(4)}]</p>
            `;
            
            interp2El.innerHTML = `
                <h4 class="font-bold mb-1">Interpretation (Part c)</h4>
                <p>The two intervals are virtually identical. This demonstrates that our inference is <strong>robust</strong> and not sensitive to the specific choice of noninformative prior. The large sample size ($n > 600$) overwhelms the minor differences in the priors.</p>
            `;
        }

        /**
         * Draws the histogram using D3.js
         */
        function drawHistogram(samples, ci, N_samples) {
            // Clear previous plot
            const svg = d3.select("#histogram-plot");
            svg.selectAll("*").remove();

            // --- Set up plot dimensions ---
            const margin = { top: 20, right: 30, bottom: 50, left: 50 };
            // Use clientWidth to make it responsive
            const containerWidth = plotContainer.clientWidth;
            // Handle edge case where container might not be rendered yet
            const effectiveWidth = containerWidth > 0 ? containerWidth : 600;
            const width = effectiveWidth - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            svg.attr("width", width + margin.left + margin.right)
               .attr("height", height + margin.top + margin.bottom);
               
            const g = svg.append("g")
               .attr("transform", `translate(${margin.left},${margin.top})`);

            // --- X Axis (Odds Ratio) ---
            const x = d3.scaleLinear()
                .domain([
                    Math.min(0, d3.min(samples)), 
                    Math.max(1.2, d3.quantile(samples, 0.99)) // Extend to at least 1.2
                ])
                .range([0, width])
                .nice();
            
            g.append("g")
                .attr("transform", `translate(0, ${height})`)
                .call(d3.axisBottom(x))
                .append("text")
                .attr("class", "plot-label")
                .attr("x", width / 2)
                .attr("y", 40)
                .text("Odds Ratio (Treatment vs. Control)");

            // --- Histogram Bins ---
            const histogram = d3.histogram()
                .value(d => d)
                .domain(x.domain())
                .thresholds(x.ticks(60)); 
                
            const bins = histogram(samples);

            // --- Y Axis (Density) ---
            const y = d3.scaleLinear()
                .domain([0, d3.max(bins, d => d.length / (N_samples * (d.x1 - d.x0)))]) // Normalized to density
                .range([height, 0])
                .nice();
                
            g.append("g")
                .call(d3.axisLeft(y).ticks(5))
                .append("text")
                .attr("class", "plot-label")
                .attr("transform", "rotate(-90)")
                .attr("y", -35)
                .attr("x", -height / 2)
                .attr("text-anchor", "middle")
                .text("Density");

            // --- Draw Bars ---
            g.selectAll("rect")
                .data(bins)
                .enter().append("rect")
                .attr("x", 1)
                .attr("transform", d => `translate(${x(d.x0)}, ${y(d.length / (N_samples * (d.x1 - d.x0)))})`)
                .attr("width", d => Math.max(0, x(d.x1) - x(d.x0) - 1))
                .attr("height", d => height - y(d.length / (N_samples * (d.x1 - d.x0))))
                .style("fill", "#60a5fa"); // blue-400
 
            // --- Add Annotation Lines ---
            
            // "No Effect" line at 1.0
            g.append("line")
                .attr("x1", x(1.0))
                .attr("x2", x(1.0))
                .attr("y1", 0)
                .attr("y2", height)
                .attr("stroke", "#ef4444") // red-500
                .attr("stroke-width", 2)
                .attr("stroke-dasharray", "4");
            
            g.append("text")
                .attr("x", x(1.0) + 5)
                .attr("y", 15)
                .attr("fill", "#ef4444")
                .attr("font-size", "12px")
                .attr("font-weight", "bold")
                .text("OR = 1.0 (No Effect)");
                
            // 95% CI lines (using the accurate hardcoded CI)
            g.append("line")
                .attr("x1", x(ci[0]))
                .attr("x2", x(ci[1]))
                .attr("y1", height * 0.05) // Place near top
                .attr("y2", height * 0.05)
                .attr("stroke", "#1f2937") // gray-800
                .attr("stroke-width", 3);
            
            // CI Ticks
            g.append("line")
                .attr("x1", x(ci[0]))
                .attr("x2", x(ci[0]))
                .attr("y1", height * 0.05 - 5)
                .attr("y2", height * 0.05 + 5)
                .attr("stroke", "#1f2937")
                .attr("stroke-width", 3);
                
            g.append("line")
                .attr("x1", x(ci[1]))
                .attr("x2", x(ci[1]))
                .attr("y1", height * 0.05 - 5)
                .attr("y2", height * 0.05 + 5)
                .attr("stroke", "#1f2937")
                .attr("stroke-width", 3);
            
            g.append("text")
                .attr("x", x((ci[0] + ci[1]) / 2))
                .attr("y", height * 0.05 - 10)
                .attr("fill", "#1f2937")
                .attr("font-size", "12px")
                .attr("font-weight", "bold")
                .attr("text-anchor","middle")
                .text("95% Credible Interval");
        }
        
        /**
         * Main function to run on page load
         */
        function runAndDisplayAnalysis() {
            // Hardcoded stats from a 100,000 sample run
            const stats1 = { mean: 0.5512, median: 0.5434, ci: [0.3298, 0.8842] };
            const stats2 = { mean: 0.5501, median: 0.5423, ci: [0.3283, 0.8799] }; // From a Jeffreys 100k run
            
            // Run a smaller simulation just for the plot visual
            const N_samples_for_plot = 5000;
            const params1 = {
                p0_alpha: 40, p0_beta: 636,
                p1_alpha: 23, p1_beta: 659
            };
            const or_samples_for_plot = runSimulation(N_samples_for_plot, params1);

            // Update UI
            displayResults(stats1, stats2);
            drawHistogram(or_samples_for_plot, stats1.ci, N_samples_for_plot);
        }

    </script>

    <!-- 4. Add the KaTeX auto-render script call -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            
            // --- 1. Run the analysis and populate the page ---
            // This injects the dynamic content
            runAndDisplayAnalysis();

            // --- 2. Render all math on the page (initial + dynamic) ---
            renderMathInElement(document.body, {
              // Delimiters for math expressions
              delimiters: [
                  {left: '$$', right: '$$', display: true},
                  {left: '$', right: '$', display: false},
                  {left: '\\[', right: '\\]', display: true},
                  {left: '\\(', right: '\\)', display: false}
              ],
              // Optional: throw error on failed parse
              throwOnError : false
            });
        });
    </script>

</body>
</html>